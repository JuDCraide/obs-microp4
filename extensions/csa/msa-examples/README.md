# Composing Dataplane Programs with μP4 - SIGCOMM '20

Instructions to reproduce results published in the paper titled "Composing Dataplane Programs with μP4".
μP4C is source-to-source compiler. It can translate μP4 programs to P4 programs specific to two real target architectures,[v1model (BMv2)](https://github.com/hksoni/p4c/blob/master/p4include/v1model.p4) and [Tofino](https://www.barefootnetworks.com/products/brief-tofino/). It is necessary to use the specified versions of both architectures, because μP4C backends are target specific.

- `v1model` : It is included as a submodule (`p4c`) in this directory.
- Tofino : bf-sde-9.0.0.  It is recommended to install the SDE in this directory of your local clone. However, you are free to install anywhere as long as necessary environment variables are configured properly.

## Prerequisites
Download and install μP4C along with associated version of p4c and BMv2 by following steps described at [here](https://github.com/cornell-netlab/MicroP4/blob/master/README.md).

## How to Compile Examples
### 0. Prerequisites
μP4C requires target-specific architecture file to generate P4 source of μP4 program.
1.  `v1model.p4` - The compatible version is already available at [p4include/v1model.p4](https://github.com/cornell-netlab/MicroP4/blob/master/p4include/v1model.p4) path of this repository.
2. Tofino architecture files - It is recommended to put your copy of `.p4` of tofino architecture at the same location `p4include`.
If you face erors from μP4C complaining absence of architecture files, copy them at `<repo root (microp4)>/build/p4include`.

It is recommended to briefly understand build structure and Makefile. However, you are free to skip [1. Makefile](https://github.com/cornell-netlab/MicroP4/tree/master/extensions/csa/msa-examples#1-makefile) and move to [2. Compile](https://github.com/cornell-netlab/MicroP4/tree/master/extensions/csa/msa-examples#2-compile)
### 1. Makefile
The makefile in this directory executes every step of compilation process described in the paper. In brief, there are two major steps.
1. μP4 program to architecture-specific P4 program - Uses μP4C
2. architecture-specific P4 program to executable files for the target - Uses p4c or barefoot compiler

#### Step 1
The makefile creates a directory, named `build`, and copies compilation output for every main program at `main-programs` in the `build` directory.
For example, Compiling `main-programs/routerv4_main.up4` with `p4c-msa` for v1model would generate `routerv4_main_v1model.p4` and move it to `build/routerv4_main_v1model/`. Similarly, for tofino, `routerv4_main_tna.p4` will be available at `build/routerv4_main_tna/`.
The makefile performs this step using a function, `p4c_msa_compile`, defined in it. You are invited to look at it and change your local copy as needed.

#### Step 2 with p4c
The makefile compiles μP4C-generated P4 program with `p4c` compiler added as submodule in this directory. The files generated by the compilation process is copied to appropriate subdirectory of `build`. `p4c_bmv2_compile` function in the makefile compiles P4 sources. For example, `build/routerv4_main_v1model` will contain `routerv4_main_v1model.p4rt` and `routerv4_main_v1model.json`.

#### Step 2 with Barefoot compiler
The makefile has necessary function `p4c_tna_compile` to
1. compile and install P4 programs(μP4C-generated, tofino-specific) with bf-sde-9.0.0.
2. copy PTF tests ([tofino-ptf](https://github.com/cornell-netlab/MicroP4/tree/master/extensions/csa/msa-examples/tofino-ptf)) and at appropriate location within your local installation of bf-sde-9.0.0. 

It is mandatory to store location of the SDE in `SDE` and `SDE_INSTALL` environment variables before invoking `make`.

### 2. Compile
#### For v1model
```
make TARGET=v1model
```
#### For Tofino
```
make TARGET=tna
```
### 3. Execute
#### With BMv2
##### Prerequisites
Install Mininet system-wide from [here](https://github.com/mininet/mininet/blob/master/INSTALL). For Ubuntu, just run `sudo apt install mininet`.

The submodule `bmv2` contains mininet scripts for the examples at `mininet/msa-examples` directory. They can be launched from this directory (`./extensions/csa/msa-examples`) using `run_up4_v1model.sh` as follows.
```bash
./run_up4_v1model.sh
```
This command will launch instances of Mininet with each composed program, and verify that packets can be sent through the composed dataplane.

#### With Tofino
##### Prerequisites
You need to have access to proprietary Barefoot SDE 9.0.0.
To execute programs with Tofino, PTF tests are provided at `./tofino-ptf`.
`make` would configure, compile and install μP4C-generated P4 source for `tna` along with ptf tests at appropriate location in your local installation of SDE.

To launch PTF tests
```bash
a one a two a you know what to do!!
```
